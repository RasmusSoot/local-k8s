{
  "$schema": "https://raw.githubusercontent.com/jetify-com/devbox/0.16.0/.schema/devbox.schema.json",
  "packages": [
    "python314@latest",
    "pack@latest",
    "kind@latest",
    "cloud-provider-kind@latest",
    "kubectl@latest",
    "k9s@latest",
    "jq@latest"
  ],
  "shell": {
    "init_hook": [
      ". $VENV_DIR/bin/activate",
      "type mdslides || pip install -r requirements.txt"
    ],
    "scripts": {
      "build-slides": [
        "mdslides public.md --include media"
      ],
      "build-image": [
        "pack build slides:local --buildpack paketo-buildpacks/nginx --builder paketobuildpacks/builder-jammy-base --env BP_WEB_SERVER=nginx"
      ],
      "kind:create-cluster": [
        "kind create cluster --config kubernetes/kind-cluster.yaml"
      ],
      "kind:publish-image": [
        "kind load docker-image slides:local"
      ],
      "kubectl:apply:loadbalancer": [
        "kubectl apply -f chart/slides-loadbalancer.yml"
      ],
      "just-work": [
        "devbox run build-slides",
        "devbox run build-image",
        "devbox run kind:create-cluster",
        "devbox run kind:publish-image",
        "devbox run kubectl:apply:loadbalancer",
        "devbox services start kind-lb",
        "kubectl wait --for=jsonpath='{.status.loadBalancer.ingress}' service/lb-service-local --timeout=30s",
        "echo \"http://$(kubectl get service/lb-service-local -o=jsonpath='{.status.loadBalancer.ingress[0].ip}')\""
      ],
      "cleanup": [
        "devbox services stop",
        "kind delete cluster"
      ],
      "add-additional-tools": [
        "jq --slurpfile additional devbox-additional-tools.json '.packages += $additional[0].packages' devbox.json > devbox.json.tmp && mv devbox.json.tmp devbox.json",
        "devbox install",
        "devbox shell"
      ],
      "gateway-alpha": [
        "devbox run build-slides",
        "devbox run build-image",
        "devbox run kind:create-cluster",
        "devbox run kind:publish-image",
        "GOBIN=$PWD/bin go install sigs.k8s.io/cloud-provider-kind@latest",
        "devbox services start kind-gateway-alpha",
        "kubectl apply -f chart/slides-gateway-httproute.yaml",
        "kubectl get gateway"
      ],
      "k8s:dashboard:install": [
        "kubectl apply -f https://raw.githubusercontent.com/kubernetes/dashboard/v2.7.0/aio/deploy/recommended.yaml -f kubernetes/local-k8s-dashboard-admin.yaml"
      ],
      "k8s:dashboard:token": [
        "kubectl get secret admin-user -n kubernetes-dashboard -o jsonpath={\".data.token\"} | base64 -d && echo"
      ],
      "k8s:dashboard:proxy": [
        "kubectl port-forward svc/kubernetes-dashboard -n kubernetes-dashboard 4443:443"
      ]
    }
  }
}
